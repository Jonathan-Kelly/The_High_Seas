############################
# MARKET
############################

#define THS_MARKET X Y
    [event]
        name=start
        [store_locations]
            x={X}
            y={Y}
            variable=market_locations
        [/store_locations]
    [/event]
    [event]
        name=side turn
        {FOREACH market_locations i}
            {PLACE_IMAGE scenery/tent-shop-weapons.png $market_locations[$i].x $market_locations[$i].y}
            {SET_LABEL $market_locations[$i].x $market_locations[$i].y "Market"}
        {NEXT i}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x={X}
            y={Y}
            side="1,2,3"
            canrecruit=yes
        [/filter]
        [store_side]
            side=$side_number
            variable=trader
        [/store_side]

        {VARIABLE finished_trading no}

        [while]
            [variable]
                name=finished_trading
                equals=no
            [/variable]
            [do]
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    caption=_ "Market"
                    message= _ "Here you can buy personal equipment for yourself.
 
You have $trader.gold|g"
                    [option]
                        message= _ "Leave"
                        [command]
                            {VARIABLE finished_trading yes}
                        [/command]
                    [/option]

                    # Potions

                    [option]
                        image=items/potion-red.png
                        message= _ "<span color='cyan'>Potions</span>
Restores your captain's hitpoints and cure poison.
Price: 12g"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 12}
                                [then]
                                    {THS_GOLD $side_number -12}
                                    {FULL_HEAL x,y=$x1,$y1}
                                    [sound]
                                        name=squishy-miss.wav
                                    [/sound]
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Nitro Bomb

                    [option]
                        image=items/bomb.png
                        message= _ "<span color='cyan'>Nitro Bomb</span>
Gives your captain a 30-1 fire ranged attack.
`Note: This weapon is removed after use.
Price: 20g"
                        [show_if]
                            {VARIABLE_CONDITIONAL bomb_$side_number equals no}
                        [/show_if]
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 20}
                                [then]
                                    {VARIABLE bomb_$side_number yes}
                                    [object]
                                        silent=yes
                                        duration=forever
                                        [filter]
                                            x=$x1
                                            y=$y1
                                        [/filter]
                                        [effect]
                                            apply_to=new_attack
                                            name= _ "nitro bomb"
                                            icon=attacks/magic-missile.png
                                            type=fire
                                            range=ranged
                                            damage=30
                                            number=1
                                            defense_weight=0
                                        [/effect]
                                        [effect]
                                            apply_to=new_animation
                                            [attack_anim]
                                                [filter_attack]
                                                    name="nitro bomb"
                                                [/filter_attack]
                                                [missile_frame]
                                                    begin=-150
                                                    end=0
                                                    image="items/bomb.png"
                                                    image_diagonal="items/bomb.png"
                                                [/missile_frame]
                                                {FIRE_BURST_SMALL}
                                                [frame]
                                                    begin=-300
                                                    end=-100
                                                    sound=throw-1.wav
                                                [/frame]
                                            [/attack_anim]
                                        [/effect]
                                    [/object]
                                    {THS_GOLD $side_number -20}
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Diving Suit

                    [option]
                        image=items/armor.png
                        message= _ "<span color='cyan'>Diving Suit</span>
Allows you to swim submerged in deep water.
Price: 15g"
                        [show_if]
                            {VARIABLE_CONDITIONAL diving_suit_$side_number equals no}
                        [/show_if]
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 15}
                                [then]
                                    {VARIABLE diving_suit_$side_number yes}
                                    [object]
                                        silent=yes
                                        duration=forever
                                        [filter]
                                            x=$x1
                                            y=$y1
                                        [/filter]
                                        [effect]
                                            apply_to=movement_costs
                                            replace=true
                                            [movement_costs]
                                                deep_water=2
                                            [/movement_costs]
                                        [/effect]
                                        [effect]
                                            apply_to=new_ability
                                            [abilities]
                                                {ABILITY_SUBMERGE}
                                            [/abilities]
                                        [/effect]
                                    [/object]
                                    {THS_GOLD $side_number -15}
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]
                [/message]
            [/do]
        [/while]
    [/event]
#enddef

############################
# TAVERN
############################

#define THS_TAVERN X Y
    [event]
        name=start
        [store_locations]
            x={X}
            y={Y}
            variable=tavern_locations
        [/store_locations]
    [/event]
    [event]
        name=side turn
        {FOREACH tavern_locations i}
            {SET_LABEL $tavern_locations[$i].x $tavern_locations[$i].y "Tavern"}
        {NEXT i}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x={X}
            y={Y}
            canrecruit=yes
        [/filter]
        [store_side]
            side=$side_number
            variable=trader
        [/store_side]

        {VARIABLE finished_trading no}

        [while]
            [variable]
                name=finished_trading
                equals=no
            [/variable]
            [do]
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    caption=_ "Tavern"
                    message= _ "Here you can hire outlaws to join your crew.
 
You have $trader.gold|g
 "

                    [option]
                        message= _ "Leave"
                        [command]
                            {VARIABLE finished_trading yes}
                        [/command]
                    [/option]

                    # Recruit Ruffian

                    [option]
                        image=units/human-peasants/ruffian.png
                        message= _ "<span color='cyan'>Hire Ruffian</span>  (6g)"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 6}
                                [then]
                                    {GENERIC_UNIT $side_number Ruffian $x1 $y1}
                                    {THS_GOLD $side_number -6}
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Recruit Thug

                    [option]
                        image=units/human-outlaws/thug.png
                        message= _ "<span color='cyan'>Hire Thug</span>  13g"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 13}
                                [then]
                                    {GENERIC_UNIT $side_number Thug $x1 $y1}
                                    {THS_GOLD $side_number -13}
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Recruit Footpad

                    [option]
                        image=units/human-outlaws/footpad.png
                        message= _ "<span color='cyan'>Hire Footpad</span>  14g"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 14}
                                [then]
                                    {GENERIC_UNIT $side_number Footpad $x1 $y1}
                                    {THS_GOLD $side_number -14}
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Recruit Poacher

                    [option]
                        image=units/human-outlaws/poacher.png
                        message= _ "<span color='cyan'>Hire Poacher</span>  14g"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 14}
                                [then]
                                    {GENERIC_UNIT $side_number Poacher $x1 $y1}
                                    {THS_GOLD $side_number -14}
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Recruit Thief

                    [option]
                        image=units/human-outlaws/thief.png
                        message= _ "<span color='cyan'>Hire Thief</span>  13g"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 13}
                                [then]
                                    {GENERIC_UNIT $side_number Thief $x1 $y1}
                                    {THS_GOLD $side_number -13}
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]
                [/message]
            [/do]
        [/while]
    [/event]
#enddef

############################
# FARMHOUSE
############################

#define THS_FARMHOUSE X Y
    [event]
        name=start
        [store_locations]
            x={X}
            y={Y}
            variable=farmhouse_locations
        [/store_locations]
    [/event]

    [event]
        name=side turn
        {FOREACH farmhouse_locations i}
            {SET_LABEL $farmhouse_locations[$i].x $farmhouse_locations[$i].y "Farmhouse"}
        {NEXT i}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x={X}
            y={Y}
            side="1,2,3"
            canrecruit=yes
        [/filter]
        [store_side]
            side=$side_number
            variable=trader
        [/store_side]

        {VARIABLE finished_trading no}

        [while]
            [variable]
                name=finished_trading
                equals=no
            [/variable]
            [do]
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    caption=_ "Farmhouse"
                    message= _ "Here you can hire farmers to join your crew.
 
You have $trader.gold|g
 "

                    [option]
                        message= _ "Leave"
                        [command]
                            {VARIABLE finished_trading yes}
                        [/command]
                    [/option]

                    # Recruit Peasant

                    [option]
                        image=units/human-peasants/peasant.png
                        message= _ "<span color='cyan'>Hire Peasant</span>  8g"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 8}
                                [then]
                                    {GENERIC_UNIT $side_number Peasant $x1 $y1}
                                    [gold]
                                        side=$side_number
                                        amount=-8
                                    [/gold]
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Recruit Woodsman

                    [option]
                        image=units/human-peasants/woodsman.png
                        message= _ "<span color='cyan'>Hire Woodsman</span>  10g"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 10}
                                [then]
                                    {GENERIC_UNIT $side_number Woodsman $x1 $y1}
                                    [gold]
                                        side=$side_number
                                        amount=-10
                                    [/gold]
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]
                [/message]
            [/do]
        [/while]
    [/event]
#enddef

############################
# TEMPLE
############################

#define THS_TEMPLE X Y
    [event]
        name=start
        [store_locations]
            x={X}
            y={Y}
            variable=temple_locations
        [/store_locations]
    [/event]

    [event]
        name=side turn
        {FOREACH temple_locations i}
            {SET_LABEL $temple_locations[$i].x $temple_locations[$i].y "Temple"}
            {PLACE_IMAGE scenery/temple1.png $temple_locations[$i].x $temple_locations[$i].y}
        {NEXT i}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x={X}
            y={Y}
            side="1,2,3"
            canrecruit=yes
        [/filter]
        [store_side]
            side=$side_number
            variable=trader
        [/store_side]

        {VARIABLE finished_trading no}

        [while]
            [variable]
                name=finished_trading
                equals=no
            [/variable]
            [do]
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    caption=_ "Temple"
                    message= _ "Here you can hire mages to join your crew.
 
You have $trader.gold|g
"

                    [option]
                        message= _ "Leave"
                        [command]
                            {VARIABLE finished_trading yes}
                        [/command]
                    [/option]

                    # Recruit Mage

                    [option]
                        image=units/human-magi/mage.png
                        message= _ "<span color='cyan'>Hire Mage</span>  20g"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 20}
                                [then]
                                    {GENERIC_UNIT $side_number Mage $x1 $y1}
                                    {THS_GOLD $side_number -20}
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Recruit Dark Adept

                    [option]
                        image=units/undead-necromancers/adept.png
                        message= _ "<span color='cyan'>Hire Dark Adept</span>  16g"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 16}
                                [then]
                                    {GENERIC_UNIT $side_number "Dark Adept" $x1 $y1}
                                    {THS_GOLD $side_number -16}
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]
                [/message]
            [/do]
        [/while]
    [/event]
#enddef

############################
# BARRACKS
############################

#define THS_BARRACKS X Y
    [event]
        name=start
        [store_locations]
            x={X}
            y={Y}
            variable=barracks_locations
        [/store_locations]
    [/event]

    [event]
        name="side turn"
        {FOREACH barracks_locations i}
            {SET_LABEL $barracks_locations[$i].x $barracks_locations[$i].y "Barracks"}
        {NEXT i}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x={X}
            y={Y}
            side="1,2,3"
            canrecruit=yes
        [/filter]
        [store_side]
            side=$side_number
            variable=trader
        [/store_side]

        {VARIABLE finished_trading no}

        [while]
            [variable]
                name=finished_trading
                equals=no
            [/variable]
            [do]
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    caption=_ "Barracks"
                    message= _ "Here you can hire soldiers to join your crew.
 
You have $trader.gold|g
 "

                    [option]
                        message= _ "Leave"
                        [command]
                            {VARIABLE finished_trading yes}
                        [/command]
                    [/option]

                    # Recruit Spearman

                    [option]
                        image=units/human-loyalists/spearman.png
                        message= _ "<span color='cyan'>Hire Spearman</span>  14g"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 14}
                                [then]
                                    {GENERIC_UNIT $side_number Spearman $x1 $y1}
                                    [gold]
                                        side=$side_number
                                        amount=-14
                                    [/gold]
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Recruit Bowman

                    [option]
                        image=units/human-loyalists/bowman.png
                        message= _ "<span color='cyan'>Hire Bowman</span>  15g"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 15}
                                [then]
                                    {GENERIC_UNIT $side_number Bowman $x1 $y1}
                                    [gold]
                                        side=$side_number
                                        amount=-15
                                    [/gold]
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Recruit Fencer

                    [option]
                        image=units/human-loyalists/fencer.png
                        message= _ "<span color='cyan'>Hire Fencer</span>  16g"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 16}
                                [then]
                                    {GENERIC_UNIT $side_number Fencer $x1 $y1}
                                    [gold]
                                        side=$side_number
                                        amount=-16
                                    [/gold]
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Recruit Heavy Infantryman

                    [option]
                        image=units/human-loyalists/heavyinfantry.png
                        message= _ "<span color='cyan'>Hire Heavy Infantryman</span>  19g"
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 19}
                                [then]
                                    {GENERIC_UNIT $side_number "Heavy Infantryman" $x1 $y1}
                                    [gold]
                                        side=$side_number
                                        amount=-19
                                    [/gold]
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]
                [/message]
            [/do]
        [/while]
    [/event]
#enddef

############################
# SHIPYARD
############################

#define THS_SHIPYARD X Y
    [event]
        name=start
        [store_locations]
            x={X}
            y={Y}
            variable=shipyard_locations
        [/store_locations]
    [/event]

    [event]
        name="side turn"
        {FOREACH shipyard_locations i}
            {SET_LABEL $shipyard_locations[$i].x $shipyard_locations[$i].y "Shipyard"}
        {NEXT i}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x={X}
            y={Y}
            side="1,2,3"
            role=ship
        [/filter]

        [store_side]
            side=$side_number
            variable=trader
        [/store_side]

        [store_unit]
            [filter]
                x=$x1
                y=$y1
            [/filter]
            variable=ship
        [/store_unit]

        {VARIABLE finished_trading no}

        [while]
            [variable]
                name=finished_trading
                equals=no
            [/variable]
            [do]
                [message]
                    speaker=narrator
                    caption=_ "Shipyard"
                    message= _ "Here you can buy equipment and improvements for your ship.
 
You have $trader.gold|g
"

                    [option]
                        message= _ "Leave"
                        [command]
                            {VARIABLE finished_trading yes}
                            [unstore_unit]
                                variable=ship
                            [/unstore_unit]
                            {THS_REFRESH_CARGO_LABELS $ship.id}
                            {THS_REFRESH_CREW $ship.id 0 0}
                        [/command]
                    [/option]

                    # Repairs

                    [option]
                        image=units/transport/galleon.png
                        message= _ "<span color='cyan'>Hull Repairs</span>
Restores ship to full hitpoints.
Price: 30g"
                        [show_if]
                            {VARIABLE_CONDITIONAL ship.hitpoints less_than $ship.max_hitpoints}
                        [/show_if]
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 30}
                                [then]
                                    {VARIABLE ship.hitpoints $ship.max_hitpoints}
                                    {THS_GOLD $side_number -30}
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Naval Ram

                    [option]
                        image=attacks/claws-shadow.png
                        message= _ "<span color='cyan'>Naval Ram</span>
Doubles ship's ram damage.
Price: 40g"
                        [show_if]
                            {VARIABLE_CONDITIONAL ship.variables.ram less_than 2}
                        [/show_if]
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 40}
                                [then]
                                    {VARIABLE ship.attack[0].icon "attacks/claws-shadow.png"}
                                    {VARIABLE_OP ship.variables.ram add 1}
                                    {THS_GOLD $side_number -40}
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Brass Cannons

                    [option]
                        image=attacks/thunderstick.png
                        message= _ "<span color='cyan'>Brass Cannons</span>
+4 to ship's cannon damage.
Price: 80g"
                        [show_if]
                            {VARIABLE_CONDITIONAL ship.attack[1].damage less_than 17}
                        [/show_if]
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 80}
                                [then]
                                    {VARIABLE ship.variables.brass_cannons yes}
                                    {VARIABLE_OP ship.attack[1].damage add 4}
                                    {THS_GOLD $side_number -80}
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    # Cargo Hold

                    [option]
                        image=items/barrel.png
                        message= _ "<span color='cyan'>Expand Cargo Hold</span>
Allows you to store 3 extra barrels of each trade good.
Price: 100g"
                        [show_if]
                            {VARIABLE_CONDITIONAL ship.variables.hold less_than 7}
                        [/show_if]
                        [command]
                            [if]
                                {VARIABLE_CONDITIONAL trader.gold greater_than_equal_to 100}
                                [then]
                                    {VARIABLE_OP ship.variables.hold add 3}
                                    {THS_GOLD $side_number -100}
                                    [store_side]
                                        side=$side_number
                                        variable=trader
                                    [/store_side]
                                    [redraw]
                                    [/redraw]
                                [/then]
                            [/if]
                        [/command]
                    [/option]

                    image=wesnoth-icon.png
                [/message]
            [/do]
        [/while]
    [/event]
#enddef
